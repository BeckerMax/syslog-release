#!/bin/bash
set -ex

LOGDIR=/var/vcap/sys/log/syslog_forwarder

mkdir -p ${LOGDIR}
chown -R root:root ${LOGDIR}
chmod 0755 ${LOGDIR}

<% unless p('syslog.migration.disabled') %>

mkdir -p /var/vcap/data/syslog_forwarder/buffered
chown -R syslog:adm /var/vcap/data/syslog_forwarder/buffered

mkdir -p /etc/rsyslog.d

if [ $(rsyslogd -N1 -f $(dirname $0)/../config/syslog-release-custom-rules.conf) ]
then
  cp $(dirname $0)/../config/syslog-release-custom-rules.conf /etc/rsyslog.d/20-syslog-release-custom-rules.conf
fi

cp $(dirname $0)/../config/syslog-release-forwarding.conf /etc/rsyslog.d/30-syslog-release-forwarding.conf

# This just cleans up after legacy config locations
rm -f /etc/rsyslog.d/rsyslog.conf /etc/rsyslog.d/20-syslog-release.conf

service rsyslog restart

<% end %>
